<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Добавление видео</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/add_video.css') }}">
    <script>
        function validateFile() {
            const fileInput = document.getElementById('original_video');
            const file = fileInput.files[0];
            const allowedTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/wmv']; // Разрешенные типы видеофайлов

            if (file && !allowedTypes.includes(file.type)) {
                alert('Пожалуйста, загрузите только видеофайлы (MP4, AVI, MOV, WMV).');
                return false; // Останавливаем отправку формы
            }
            return true; // Продолжаем отправку формы
        }

        function showProcessingMessage() {
            if (!validateFile()) {
                return false; // Если файл не прошел проверку, не показываем сообщение о обработке
            }

            // Блокируем все кнопки на странице
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.disabled = true;
            });

            // Блокируем кнопку "Выберите файл"
            const fileInputButton = document.querySelector('.custom-file-input');
            if (fileInputButton) {
                fileInputButton.disabled = true;
                fileInputButton.style.backgroundColor = '#cccccc'; // Меняем цвет, чтобы показать, что кнопка заблокирована
                fileInputButton.style.cursor = 'not-allowed'; // Меняем курсор
            }

            // Показываем сообщение о обработке
            document.getElementById("processing-container").style.display = "block";
            return true; // Продолжаем отправку формы
        }

        function loadAthletes(groupId) {
            const athleteSelect = document.getElementById('athlete_id');
            athleteSelect.innerHTML = '<option value="">Загрузка...</option>';

            fetch(`/athletes_by_group/${groupId}`)
                .then(response => response.json())
                .then(data => {
                    athleteSelect.innerHTML = '<option value="">Выберите спортсмена</option>';
                    data.forEach(athlete => {
                        const option = document.createElement('option');
                        option.value = athlete.athlete_id;
                        option.textContent = `${athlete.athlete_surname} ${athlete.athlete_name}`;
                        athleteSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    athleteSelect.innerHTML = '<option value="">Сначала выберите группу</option>';
                    console.error('Error loading athletes:', error);
                });
        }

        function updateFileName() {
            const fileInput = document.getElementById('original_video');
            const fileNameDisplay = document.getElementById('file-name');
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
            } else {
                fileNameDisplay.textContent = "Файл не выбран";
            }
        }

        // Автоматически заполняем поля группы и спортсмена, если они переданы
        window.onload = function() {
            const groupId = "{{ group_id }}";
            const athleteId = "{{ athlete_id }}";

            if (groupId && athleteId) {
                document.getElementById('group_id').value = groupId;
                loadAthletes(groupId);

                // Ждем, пока загрузятся спортсмены, и затем выбираем нужного
                setTimeout(() => {
                    document.getElementById('athlete_id').value = athleteId;
                }, 500);
            } else {
                // Если group_id и athlete_id не переданы, устанавливаем значения по умолчанию
                document.getElementById('group_id').value = "";
                document.getElementById('athlete_id').innerHTML = '<option value="">Выберите спортсмена</option>';
            }

            // Инициализация отображения имени файла
            updateFileName();
        };
    </script>
</head>
<body>
    <div class="container">
        <form method="POST" enctype="multipart/form-data" onsubmit="return showProcessingMessage()">
            <label for="group_id">Группа:</label>
            <select id="group_id" name="group_id" onchange="loadAthletes(this.value)" required>
                <option value="">Выберите группу</option>
                {% for group in groups|sort(attribute='1') %}
                <option value="{{ group[0] }}" {% if group[0] == group_id %}selected{% endif %}>{{ group[1] }}</option>
                {% endfor %}
            </select>
            <br>

            <label for="athlete_id">Спортсмен:</label>
            <select id="athlete_id" name="athlete_id" required>
                <option value="">Выберите спортсмена</option>
                {% if athletes %}
                    {% for athlete in athletes %}
                    <option value="{{ athlete[0] }}" {% if athlete[0] == athlete_id %}selected{% endif %}>{{ athlete[1] }} {{ athlete[2] }}</option>
                    {% endfor %}
                {% endif %}
            </select>
            <br>

            <label for="element_id">Элемент:</label>
            <select id="element_id" name="element_id" required>
                <option value="">Выберите элемент</option>  
                {% for element in elements %}
                <option value="{{ element[0] }}">{{ element[1] }}</option>
                {% endfor %}
            </select>
            <br>

            <label for="training_date">Дата тренировки:</label>
            <input type="date" id="training_date" name="training_date" required>
            <br>

            <div class="file-input-container">
                <label for="original_video" class="custom-file-input">Выберите файл</label>
                <input type="file" id="original_video" name="original_video" required onchange="updateFileName()" accept="video/mp4, video/avi, video/mov, video/wmv">
                <div id="file-name" class="file-name">Файл не выбран</div>
            </div>
            <br>

            <button type="submit" id="submit-button">Загрузить видео</button>
        </form>

        <!-- Окно обработки -->
        <div id="processing-container">
            Видео обрабатывается... Пожалуйста, подождите.
            <div class="spinner"></div>
        </div>

        <form action="{{ url_for('index') }}" method="GET">
            <button type="submit" class="back-button" id="back-button">Вернуться на главную</button>
        </form>
    </div>
</body>
</html>